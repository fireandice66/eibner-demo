<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eibner & Regnath ‚Äì KI Assistent</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(30,95,168,0.4)}50%{box-shadow:0 0 0 8px transparent}}
*{box-sizing:border-box;margin:0;padding:0;}
body{min-height:100vh;background:#EEF4FB;display:flex;align-items:center;justify-content:center;font-family:'Inter',sans-serif;padding:20px;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:#C5D9F0;border-radius:2px;}

.chat-wrap{width:100%;max-width:440px;background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.12);display:flex;flex-direction:column;height:90vh;max-height:700px;animation:slideUp 0.5s ease;border:1px solid #C5D9F0;}

/* HEADER */
.header{background:linear-gradient(135deg,#0D3F7A,#1E5FA8);padding:18px 20px;display:flex;align-items:center;gap:14px;flex-shrink:0;}
.avatar{position:relative;}
.avatar-inner{width:52px;height:52px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;animation:pulse 2s infinite;padding:4px;}
.avatar-inner img{width:100%;height:100%;object-fit:contain;}
.online-dot{position:absolute;bottom:-2px;right:-2px;width:12px;height:12px;border-radius:50%;background:#22c55e;border:2px solid #0D3F7A;}
.header-info{flex:1;}
.header-name{color:#fff;font-weight:700;font-size:14px;}
.header-sub{color:rgba(255,255,255,0.65);font-size:11px;margin-top:2px;}
.header-btn{background:#fff;color:#1E5FA8;border:none;border-radius:8px;padding:7px 14px;font-size:11px;cursor:pointer;font-weight:700;font-family:'Inter',sans-serif;white-space:nowrap;}
.header-btn:hover{background:#EEF4FB;}

/* BANNER */
.banner{background:#1E5FA8;padding:6px 20px;font-size:10px;color:rgba(255,255,255,0.85);font-weight:600;letter-spacing:1px;text-transform:uppercase;flex-shrink:0;}

/* MESSAGES */
.messages{flex:1;overflow-y:auto;padding:20px 16px 10px;display:flex;flex-direction:column;gap:14px;background:#F7FAFD;}
.msg-wrap{display:flex;flex-direction:column;animation:fadeIn 0.3s ease;}
.msg-wrap.user{align-items:flex-end;}
.msg-wrap.bot{align-items:flex-start;}
.msg-bubble{max-width:82%;padding:11px 15px;font-size:14px;line-height:1.6;word-break:break-word;border-radius:18px;}
.msg-bubble.user{background:#1E5FA8;color:#fff;border-radius:18px 18px 4px 18px;}
.msg-bubble.bot{background:#fff;color:#2a2a2a;border-radius:18px 18px 18px 4px;border:1px solid #C5D9F0;}
.msg-time{color:#bbb;font-size:10px;margin-top:4px;}

/* TYPING */
.typing-wrap{display:flex;}
.typing{display:flex;background:#fff;border:1px solid #C5D9F0;padding:12px 16px;border-radius:18px 18px 18px 4px;gap:5px;align-items:center;}
.dot{width:8px;height:8px;border-radius:50%;background:#1E5FA8;}
.dot:nth-child(1){animation:bounce 1.2s 0s infinite ease-in-out}
.dot:nth-child(2){animation:bounce 1.2s 0.2s infinite ease-in-out}
.dot:nth-child(3){animation:bounce 1.2s 0.4s infinite ease-in-out}

/* QUICK BUTTONS */
.quick-wrap{display:flex;flex-direction:column;gap:7px;margin-top:4px;}
.quick-btn{background:#fff;border:1.5px solid #C5D9F0;color:#444;border-radius:10px;padding:10px 14px;font-size:13px;cursor:pointer;text-align:left;line-height:1.4;font-family:'Inter',sans-serif;transition:all 0.2s;}
.quick-btn:hover{border-color:#1E5FA8;color:#1E5FA8;}

/* INPUT */
.input-area{padding:14px 16px;border-top:1px solid #C5D9F0;background:#fff;flex-shrink:0;}
.input-box{display:flex;gap:8px;align-items:flex-end;background:#EEF4FB;border:1.5px solid #C5D9F0;border-radius:14px;padding:10px 14px;}
textarea{flex:1;background:transparent;border:none;color:#2a2a2a;font-size:14px;outline:none;resize:none;line-height:1.5;font-family:'Inter',sans-serif;max-height:100px;min-height:24px;}
textarea::placeholder{color:#aab;}
.send-btn{width:36px;height:36px;border-radius:10px;border:none;background:#1E5FA8;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;}
.send-btn:hover{background:#0D3F7A;}
.input-footer{display:flex;justify-content:space-between;margin-top:8px;}
.footer-l{color:#bbb;font-size:10px;}
.footer-r{color:#bbb;font-size:9px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(8px);}
.modal{background:#fff;border:2px solid #1E5FA8;border-radius:16px;padding:36px;width:380px;max-width:90vw;}
.modal-tag{color:#1E5FA8;font-size:11px;letter-spacing:3px;text-transform:uppercase;margin-bottom:8px;font-weight:700;}
.modal-title{color:#1a1a1a;font-size:22px;font-weight:700;margin-bottom:8px;}
.modal-sub{color:#666;font-size:13px;margin-bottom:24px;line-height:1.5;}
.modal-label{color:#555;font-size:11px;font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;}
.modal-input{width:100%;background:#f5f5f5;border:1.5px solid #ddd;border-radius:8px;padding:12px 16px;color:#1a1a1a;font-size:14px;outline:none;font-family:'Inter',sans-serif;margin-bottom:16px;}
.modal-input:focus{border-color:#1E5FA8;}
.modal-submit{width:100%;background:#1E5FA8;color:#fff;border:none;border-radius:8px;padding:14px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Inter',sans-serif;}
.modal-submit:hover{background:#0D3F7A;}
.modal-cancel{width:100%;background:transparent;color:#999;border:none;padding:12px;font-size:13px;cursor:pointer;font-family:'Inter',sans-serif;margin-top:4px;}
.modal-success{text-align:center;padding:20px 0;}
.modal-check{font-size:52px;margin-bottom:16px;}
.modal-thanks{color:#1E5FA8;font-size:20px;font-weight:700;}
.modal-thanks-sub{color:#666;margin-top:8px;font-size:14px;line-height:1.5;}

/* FAB */
.fab{position:fixed;bottom:24px;right:24px;background:#1E5FA8;border-radius:12px;padding:11px 18px;color:#fff;font-size:11px;letter-spacing:1px;cursor:pointer;font-weight:700;box-shadow:0 8px 24px rgba(30,95,168,0.4);font-family:'Inter',sans-serif;border:none;}
.fab:hover{background:#0D3F7A;}
</style>
</head>
<body>

<div class="chat-wrap">

  <!-- HEADER -->
  <div class="header">
    <div class="avatar">
      <div class="avatar-inner">
        <img src="https://www.eibner-regnath.de/uploads/images/25-jahre/25-Jahre-LOGO.png" alt="E+R"
          onerror="this.parentElement.innerHTML='<span style=\'font-size:11px;font-weight:900;color:#1E5FA8\'>E+R</span>'" />
      </div>
      <div class="online-dot"></div>
    </div>
    <div class="header-info">
      <div class="header-name">Eibner & Regnath Assistent</div>
      <div class="header-sub">Berching & M√ºnchen ¬∑ Jetzt online</div>
    </div>
    <button class="header-btn" onclick="openModal()">BERATUNG</button>
  </div>

  <!-- BANNER -->
  <div class="banner">ü™ü Fenster ¬∑ T√ºren ¬∑ Rolll√§den ¬∑ Smart Home ¬∑ Sicherheit</div>

  <!-- MESSAGES -->
  <div class="messages" id="messages">
    <div class="msg-wrap bot">
      <div class="msg-bubble bot">Willkommen bei <strong>Eibner & Regnath</strong>! ü™ü<br>Ich bin Ihr digitaler Berater f√ºr Fenster, T√ºren & Sonnenschutz ‚Äî wie kann ich Ihnen helfen?</div>
      <div class="msg-time" id="t0"></div>
    </div>
    <div class="msg-wrap bot" id="quickStart">
      <div class="quick-wrap">
        <button class="quick-btn" onclick="ask('Welche Fenster bieten Sie an?')">ü™ü Welche Fenster bieten Sie an?</button>
        <button class="quick-btn" onclick="ask('Was kostet eine neue Haust√ºr?')">üö™ Was kostet eine neue Haust√ºr?</button>
        <button class="quick-btn" onclick="ask('Bieten Sie Smart Home L√∂sungen an?')">üè† Bieten Sie Smart Home an?</button>
        <button class="quick-btn" onclick="openModal()">üìû Kostenlose Beratung anfragen</button>
      </div>
    </div>
  </div>

  <!-- INPUT -->
  <div class="input-area">
    <div class="input-box">
      <textarea id="userIn" placeholder="Stellen Sie Ihre Frage..." rows="1"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}"
        oninput="this.style.height='24px';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
      <button class="send-btn" onclick="send()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5">
          <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
        </svg>
      </button>
    </div>
    <div class="input-footer">
      <span class="footer-l">¬© Eibner & Regnath Fenster, T√ºren GmbH</span>
      <span class="footer-r">üîí DSGVO ¬∑ üìû 08462 / 94 24 - 0</span>
    </div>
  </div>
</div>

<!-- BERATUNG BUTTON -->
<button class="fab" onclick="openModal()">ü™ü BERATUNG ANFRAGEN</button>

<!-- MODAL -->
<div class="modal-overlay" id="modal" style="display:none">
  <div class="modal">
    <div id="modalBody">
      <div class="modal-tag">Kostenlos & unverbindlich</div>
      <div class="modal-title">Beratung anfragen</div>
      <div class="modal-sub">Hinterlassen Sie Ihre Daten ‚Äî wir melden uns innerhalb von 24 Stunden bei Ihnen.</div>
      <div class="modal-label">Ihr Name</div>
      <input class="modal-input" id="mName" type="text" placeholder="Max Mustermann" />
      <div class="modal-label">E-Mail</div>
      <input class="modal-input" id="mEmail" type="email" placeholder="max@firma.de" />
      <div class="modal-label">Telefon (optional)</div>
      <input class="modal-input" id="mTel" type="tel" placeholder="0911 / 123 456" />
      <button class="modal-submit" onclick="submitLead()">BERATUNG ANFRAGEN ‚Üí</button>
      <button class="modal-cancel" onclick="closeModal()">Abbrechen</button>
    </div>
  </div>
</div>

<script>
// API key is handled server-side

const SYSTEM = `Du bist der professionelle KI-Assistent von Eibner & Regnath Fenster, T√ºren GmbH in Berching (Oberpfalz).
Gegr√ºndet 1996. F√ºhrend in Bayern f√ºr: Fenster (Kunststoff, Holz, Alu), Haust√ºren, Rolll√§den, Raffstores, Fensterl√§den, Insektenschutz, Innent√ºren, Wohnungseingangst√ºren, Smart Home Steuerung, Alarmanlagen (seit 2016 mit TRITONIC).
Partner von Sch√ºco. German Design Award f√ºr Haust√ºren. Goldener Bauelementepreis.
Standorte: Berching (08462 / 9424-0, info@eibner-regnath.de) + M√ºnchen (089 / 665 617 98-0, muenchen@eibner-regnath.de).
Adresse: Industriepark Erasbach B2, 92334 Berching.
B√ºrozeiten: Mo‚ÄìFr 08:00‚Äì12:00 und 14:00‚Äì16:30 Uhr.
Ausstellung: Mo‚ÄìFr 08:00‚Äì12:00 und 13:00‚Äì17:00 Uhr.
N√§chste Verkaufsoffene Sonntage: 15.03.2026 und 18.10.2026, je 13‚Äì17 Uhr.

Antworte auf Deutsch, freundlich und kompetent. Maximal 3‚Äì4 S√§tze.
Bei Anfragen zu Angebot, Preis, Beratung oder Termin: Weise auf das Beratungsformular hin oder bitte um Kontaktdaten.`;

let history = [];
document.getElementById("t0").textContent = now();

function now() {
  return new Date().toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
}

function ask(txt) {
  const qs = document.getElementById("quickStart");
  if (qs) qs.remove();
  send(txt);
}

async function send(txt) {
  const input = document.getElementById("userIn");
  const msg = txt || input.value.trim();
  if (!msg) return;
  const qs = document.getElementById("quickStart");
  if (qs) qs.remove();
  input.value = "";
  input.style.height = "24px";

  addMsg("user", msg);
  history.push({role:"user", content:msg});
  showTyping();

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({system: SYSTEM, messages: history})
    });
    const data = await res.json();
    hideTyping();
    if (data.error) {
      addMsg("bot", "‚ö†Ô∏è " + data.error.message);
      return;
    }
    const reply = data.content?.[0]?.text || "Entschuldigung, bitte versuchen Sie es nochmal.";
    addMsg("bot", reply);
    history.push({role:"assistant", content:reply});

    // Auto-open modal for leads
    const lc = msg.toLowerCase();
    if (lc.includes("angebot") || lc.includes("beratung") || lc.includes("termin") || lc.includes("preis")) {
      setTimeout(openModal, 1200);
    }
  } catch(e) {
    hideTyping();
    addMsg("bot", "Verbindungsfehler. Bitte rufen Sie uns an: üìû 08462 / 9424-0");
  }
}

function addMsg(role, html) {
  const msgs = document.getElementById("messages");
  const wrap = document.createElement("div");
  wrap.className = "msg-wrap " + role;
  const bubble = document.createElement("div");
  bubble.className = "msg-bubble " + role;
  bubble.innerHTML = html;
  const time = document.createElement("div");
  time.className = "msg-time";
  time.textContent = now();
  wrap.appendChild(bubble);
  wrap.appendChild(time);
  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
}

function showTyping() {
  const msgs = document.getElementById("messages");
  const wrap = document.createElement("div");
  wrap.id = "typing";
  wrap.className = "msg-wrap bot";
  wrap.innerHTML = '<div class="typing-wrap"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>';
  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
}

function hideTyping() {
  const t = document.getElementById("typing");
  if (t) t.remove();
}

function openModal() {
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

function submitLead() {
  const name = document.getElementById("mName").value.trim();
  const email = document.getElementById("mEmail").value.trim();
  if (!name || !email) {
    alert("Bitte Name und E-Mail eingeben.");
    return;
  }
  document.getElementById("modalBody").innerHTML = `
    <div class="modal-success">
      <div class="modal-check">‚úÖ</div>
      <div class="modal-thanks">Vielen Dank, ${name}!</div>
      <div class="modal-thanks-sub">Wir haben Ihre Anfrage erhalten und melden uns<br>in K√ºrze bei Ihnen unter <strong>${email}</strong>.</div>
    </div>`;
  setTimeout(closeModal, 3000);
}

document.getElementById("modal").addEventListener("click", function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
